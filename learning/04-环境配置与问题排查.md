# 环境配置与问题排查指南

> 记录 Shopify AI 客服机器人项目的完整配置过程和遇到的问题

---

## 一、环境准备清单

### 1.1 必需账号

| 项目 | 说明 | 获取方式 |
|------|------|---------|
| Claude API Key | 调用 AI 大模型 | https://console.anthropic.com |
| Shopify Partner 账号 | 创建开发 App | https://partners.shopify.com |
| Shopify 开发店铺 | 测试用的店铺 | Partner 后台免费创建 |

### 1.2 本地环境要求

```bash
# Node.js >= 20
node --version  # v22.14.0

# npm
npm --version   # 10.9.2

# Shopify CLI
shopify version # 3.88.0
```

### 1.3 安装 Shopify CLI

```bash
npm install -g @shopify/cli @shopify/app
```

---

## 二、项目配置

### 2.1 克隆项目

```bash
git clone https://github.com/Shopify/shop-chat-agent.git
cd shop-chat-agent
```

### 2.2 安装依赖

```bash
# 如果遇到依赖冲突，使用 --legacy-peer-deps
npm install --legacy-peer-deps
```

### 2.3 配置环境变量

创建 `.env` 文件：

```bash
# Claude API 配置
CLAUDE_API_KEY=你的API_KEY
CLAUDE_BASE_URL=你的代理地址（可选，直连官方可不填）

# Shopify 配置（CLI 会自动填充）
SHOPIFY_API_KEY=YOUR_APP_CLIENT_ID

# 回调地址
REDIRECT_URL=https://localhost:3458/auth/callback
```

### 2.4 配置模型

文件：`app/services/config.server.js`

```javascript
export const AppConfig = {
  api: {
    defaultModel: 'claude-sonnet-4-5-20250929',  // 改成你的代理支持的模型
    maxTokens: 2000,
    defaultPromptType: 'standardAssistant',
  },
  // ...
};
```

---

## 三、启动项目

### 3.1 首次运行

```bash
shopify app dev --use-localhost
```

首次运行会：
1. 提示登录 Shopify Partner 账号
2. 创建/关联 App
3. 选择开发店铺
4. 生成 localhost 证书（需要 mkcert）

### 3.2 安装 mkcert（如果需要）

```bash
brew install mkcert
mkcert -install  # 需要输入系统密码
```

### 3.3 启动成功的标志

```
✅ Ready, watching for changes in your app

Preview URL: https://your-store.myshopify.com/admin/oauth/redirect_from_cli?...
GraphiQL URL: http://localhost:3457/graphiql
```

### 3.4 启用聊天小部件

1. 打开店铺后台：`https://your-store.myshopify.com/admin/themes`
2. 点击 **Customize**
3. 左下角找到 **App embeds**
4. 启用 **AI Chat Assistant**
5. 保存

---

## 四、常见问题排查

### 4.1 问题：Cannot find module '@shopify/shopify-api'

**原因**：缺少依赖

**解决**：
```bash
npm install @shopify/shopify-api --legacy-peer-deps
```

### 4.2 问题：403 Your request was blocked

**原因**：代理服务的 Cloudflare 拦截了请求

**排查步骤**：

1. 先用 curl 测试代理是否正常：
```bash
curl -X POST https://your-proxy.com/v1/messages \
  -H "x-api-key: your-key" \
  -H "anthropic-version: 2023-06-01" \
  -H "content-type: application/json" \
  -d '{"model":"claude-sonnet-4-5-20250929","max_tokens":100,"messages":[{"role":"user","content":"Hi"}]}'
```

2. 如果 curl 正常但项目报错，可能是请求头问题

**解决**：在 `claude.server.js` 中添加浏览器风格的请求头：

```javascript
config.defaultHeaders = {
  'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
  'Accept': 'application/json',
  'Accept-Language': 'en-US,en;q=0.9',
};
```

### 4.3 问题：400 Mismatch type with system parameter

**原因**：代理服务要求 `system` 参数是数组格式，但 SDK 发送的是字符串

**错误信息**：
```
Mismatch type []***.AnthropicSystemMessage with value string
```

**解决**：修改 `app/services/claude.server.js`

```javascript
// 修改前
const stream = await anthropic.messages.stream({
  system: systemInstruction,  // 字符串格式
  // ...
});

// 修改后
const systemArray = [{ type: "text", text: systemInstruction }];
const stream = await anthropic.messages.stream({
  system: systemArray,  // 数组格式
  // ...
});
```

### 4.4 问题：Store password is invalid

**原因**：开发店铺有密码保护

**解决**：
1. 去店铺后台 Online Store > Preferences
2. 找到 Password protection
3. 记住密码，CLI 会提示输入

### 4.5 问题：Failed to download cloudflared/mkcert

**原因**：网络问题无法下载工具

**解决**：手动安装

```bash
# 安装 mkcert
brew install mkcert
mkcert -install

# 然后使用 --use-localhost 模式
shopify app dev --use-localhost
```

---

## 五、调试技巧

### 5.1 查看终端日志

运行 `shopify app dev` 时，终端会显示：
- MCP 连接状态
- API 调用错误
- 请求/响应详情

### 5.2 测试 API 连接

创建测试脚本 `test-api.js`：

```javascript
import Anthropic from '@anthropic-ai/sdk';
import dotenv from 'dotenv';

dotenv.config();

const anthropic = new Anthropic({
  apiKey: process.env.CLAUDE_API_KEY,
  baseURL: process.env.CLAUDE_BASE_URL,
});

async function test() {
  try {
    const message = await anthropic.messages.create({
      model: 'claude-sonnet-4-5-20250929',
      max_tokens: 100,
      messages: [{ role: 'user', content: 'Hello' }]
    });
    console.log('Success!', message.content[0].text);
  } catch (error) {
    console.error('Error:', error.status, error.message);
  }
}

test();
```

运行：
```bash
node test-api.js
```

### 5.3 检查环境变量是否加载

在代码中添加日志：
```javascript
console.log('Base URL:', process.env.CLAUDE_BASE_URL);
console.log('API Key:', process.env.CLAUDE_API_KEY?.slice(0, 10) + '...');
```

---

## 六、代理服务兼容性

### 6.1 不同代理的 Base URL 格式

| 代理类型 | Base URL 格式 |
|---------|--------------|
| Anthropic 官方 | 不需要设置（默认） |
| OpenAI 兼容代理 | `https://proxy.com/v1` |
| Anthropic 兼容代理 | `https://proxy.com` 或 `https://proxy.com/v1` |

### 6.2 Anthropic SDK 的请求路径

SDK 会自动在 baseURL 后面加上 `/v1/messages`：
- 设置 `baseURL: https://proxy.com`
- 实际请求 `https://proxy.com/v1/messages`

### 6.3 常见代理兼容性问题

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 403 Forbidden | Cloudflare 拦截 | 添加浏览器 User-Agent |
| 400 Bad Request | 参数格式不兼容 | 检查 system 参数格式 |
| 401 Unauthorized | API Key 无效 | 检查 Key 是否正确 |
| 404 Not Found | 路径错误 | 检查 Base URL 格式 |

---

## 七、项目文件修改记录

### 7.1 `.env` 配置

```bash
CLAUDE_API_KEY=你的key
CLAUDE_BASE_URL=https://your-proxy.com  # 代理地址
```

### 7.2 `app/services/claude.server.js` 修改

1. **支持自定义 Base URL**：
```javascript
if (process.env.CLAUDE_BASE_URL) {
  config.baseURL = process.env.CLAUDE_BASE_URL;
}
```

2. **添加浏览器请求头**：
```javascript
config.defaultHeaders = {
  'User-Agent': 'Mozilla/5.0 ...',
  'Accept': 'application/json',
};
```

3. **system 参数数组格式**：
```javascript
const systemArray = [{ type: "text", text: systemInstruction }];
```

### 7.3 `app/services/config.server.js` 修改

```javascript
defaultModel: 'claude-sonnet-4-5-20250929',  // 改成你的模型
```

---

## 八、快速启动命令

```bash
# 1. 进入项目目录
cd /path/to/shop-chat-agent

# 2. 启动开发服务器
shopify app dev --use-localhost

# 3. 如果需要重置 App 配置
shopify app dev --reset

# 4. 查看 Shopify CLI 帮助
shopify app dev --help
```

---

## 九、下一步

项目运行成功后，可以：

1. **测试聊天功能**
   - 产品搜索
   - 购物车操作
   - 政策查询

2. **自定义 AI 风格**
   - 修改 `app/prompts/prompts.json`

3. **扩展功能**
   - 添加物流追踪
   - 集成客服系统

4. **部署到生产环境**
   - `shopify app deploy`
