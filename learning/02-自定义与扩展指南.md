# 自定义与扩展指南

> 如何根据业务需求定制这个 AI 客服机器人

---

## 一、如何自定义 AI 的回复风格？

### 1.1 修改系统提示词

文件位置：`app/prompts/prompts.json`

```json
{
  "systemPrompts": {
    "standardAssistant": {
      "content": "你的提示词内容...",
      "version": "1.0"
    }
  }
}
```

### 1.2 提示词设计技巧

#### 定义角色身份
```
你是 [品牌名] 的专属购物顾问小美，性格温柔耐心，说话简洁明了。
```

#### 设定回复风格
```
回复风格要求：
1. 使用口语化表达，避免生硬的书面语
2. 每次回复控制在 100 字以内
3. 适当使用表情符号增加亲和力
4. 遇到不确定的问题，诚实说"我帮您问一下"
```

#### 设定业务边界
```
你只回答与购物相关的问题，包括：
- 产品咨询
- 订单查询
- 退换货政策
- 配送信息

对于其他话题，礼貌地引导用户回到购物话题。
```

### 1.3 添加新的提示词风格

```json
{
  "systemPrompts": {
    "standardAssistant": { ... },
    "enthusiasticAssistant": { ... },

    "professionalAssistant": {
      "content": "你是一位专业的奢侈品顾问，用词优雅得体，展现品牌的高端定位...",
      "version": "1.0",
      "description": "适合高端品牌"
    },

    "friendlyAssistant": {
      "content": "你是用户的好朋友小明，说话随意自然，像朋友聊天一样...",
      "version": "1.0",
      "description": "适合年轻用户群体"
    }
  }
}
```

### 1.4 在前端选择提示词风格

文件：`extensions/chat-bubble/blocks/chat-interface.liquid`

```liquid
{% schema %}
{
  "settings": [
    {
      "type": "select",
      "id": "system_prompt",
      "label": "AI 风格",
      "options": [
        { "value": "standardAssistant", "label": "标准客服" },
        { "value": "enthusiasticAssistant", "label": "热情客服" },
        { "value": "professionalAssistant", "label": "专业顾问" },
        { "value": "friendlyAssistant", "label": "朋友式聊天" }
      ]
    }
  ]
}
{% endschema %}
```

### 1.5 提示词最佳实践

| 要素 | 好的做法 | 避免的做法 |
|------|---------|-----------|
| 角色定义 | 具体、有个性 | 模糊、通用 |
| 语气 | 与品牌调性一致 | 与品牌形象冲突 |
| 长度 | 简洁有力 | 冗长啰嗦 |
| 边界 | 明确能做什么、不能做什么 | 没有边界限制 |
| 格式 | 指定输出格式（列表、段落等） | 不指定格式 |

---

## 二、如何添加新的工具能力？

### 2.1 理解工具的工作原理

```
用户消息 → Claude 分析 → 决定调用哪个工具 → 执行工具 → 返回结果 → Claude 生成回复
```

工具定义告诉 Claude：
- 工具名称和描述
- 需要什么参数
- 返回什么结果

### 2.2 Shopify MCP 已提供的工具

这些工具由 Shopify 提供，开箱即用：

| 工具 | 功能 |
|------|------|
| `search_shop_catalog` | 搜索产品 |
| `update_cart` | 更新购物车 |
| `get_cart` | 获取购物车 |
| `search_shop_policies_and_faqs` | 搜索政策和FAQ |
| `get_most_recent_order_status` | 获取最近订单 |
| `get_order_status` | 获取指定订单 |

### 2.3 添加自定义工具的方式

#### 方式一：扩展 MCP Client（推荐）

创建自己的工具服务，然后在 MCP Client 中注册：

```javascript
// app/custom-tools.js
export const customTools = [
  {
    name: "check_inventory",
    description: "检查指定产品的库存数量",
    input_schema: {
      type: "object",
      properties: {
        product_id: {
          type: "string",
          description: "产品 ID"
        }
      },
      required: ["product_id"]
    }
  },
  {
    name: "get_recommendations",
    description: "根据用户浏览历史推荐产品",
    input_schema: {
      type: "object",
      properties: {
        user_id: { type: "string" },
        limit: { type: "number", default: 5 }
      }
    }
  }
];

export async function executeCustomTool(toolName, args) {
  switch (toolName) {
    case "check_inventory":
      return await checkInventory(args.product_id);
    case "get_recommendations":
      return await getRecommendations(args.user_id, args.limit);
    default:
      throw new Error(`Unknown tool: ${toolName}`);
  }
}
```

#### 方式二：修改 chat.jsx 添加工具处理

```javascript
// 在 handleChatSession 中
const allTools = [
  ...mcpClient.tools,      // Shopify MCP 工具
  ...customTools           // 自定义工具
];

// 在 onToolUse 回调中
onToolUse: async (content) => {
  const toolName = content.name;

  // 判断是 MCP 工具还是自定义工具
  if (customTools.some(t => t.name === toolName)) {
    result = await executeCustomTool(toolName, content.input);
  } else {
    result = await mcpClient.callTool(toolName, content.input);
  }
}
```

### 2.4 工具设计最佳实践

```javascript
// 好的工具定义
{
  name: "search_products",
  description: "搜索店铺中的产品。支持按名称、类别、价格范围搜索。返回匹配的产品列表，包含标题、价格、图片和链接。",
  input_schema: {
    type: "object",
    properties: {
      query: {
        type: "string",
        description: "搜索关键词，如产品名称或类别"
      },
      min_price: {
        type: "number",
        description: "最低价格（可选）"
      },
      max_price: {
        type: "number",
        description: "最高价格（可选）"
      }
    },
    required: ["query"]
  }
}
```

**关键点：**
- 描述要详细，让 Claude 知道什么时候该用这个工具
- 参数描述要清晰
- 标明哪些参数是必需的

---

## 三、如何优化用户体验？

### 3.1 响应速度优化

#### 流式输出（已实现）
用户不需要等待完整回复，可以实时看到 AI 正在输入。

#### 预加载工具列表
```javascript
// 在应用启动时预先连接 MCP，而不是每次请求都连接
let cachedTools = null;

async function getTools() {
  if (!cachedTools) {
    cachedTools = await mcpClient.connectToStorefrontServer();
  }
  return cachedTools;
}
```

#### 添加加载状态提示
```javascript
// chat.js 中已实现
ShopAIChat.UI.showTypingIndicator();  // 显示"正在输入..."
```

### 3.2 界面优化

#### 自定义聊天气泡颜色
在 Theme Editor 中可配置，或修改 CSS：

```css
/* extensions/chat-bubble/assets/chat.css */
.shop-ai-chat-bubble {
  background-color: var(--chat-bubble-color, #5046e4);
  /* 添加动画效果 */
  transition: transform 0.2s;
}

.shop-ai-chat-bubble:hover {
  transform: scale(1.1);
}
```

#### 添加快捷回复按钮
```javascript
// 在欢迎消息后显示常见问题按钮
const quickReplies = [
  "查看热销产品",
  "我的订单在哪",
  "退货政策"
];

function showQuickReplies() {
  const container = document.createElement('div');
  container.className = 'quick-replies';

  quickReplies.forEach(text => {
    const btn = document.createElement('button');
    btn.textContent = text;
    btn.onclick = () => sendMessage(text);
    container.appendChild(btn);
  });

  messagesContainer.appendChild(container);
}
```

#### 产品卡片优化
```css
.shop-ai-product-card {
  /* 添加悬停效果 */
  transition: box-shadow 0.2s;
}

.shop-ai-product-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
```

### 3.3 对话体验优化

#### 记住用户偏好
```javascript
// 保存用户偏好到 localStorage
localStorage.setItem('userPreferences', JSON.stringify({
  language: 'zh-CN',
  preferredCategories: ['服装', '鞋子']
}));

// 在提示词中使用
const userPrefs = JSON.parse(localStorage.getItem('userPreferences'));
const contextualPrompt = `用户偏好：${userPrefs.preferredCategories.join('、')}`;
```

#### 智能建议
```javascript
// 根据对话内容显示相关建议
function showSuggestions(lastMessage) {
  if (lastMessage.includes('滑雪板')) {
    showQuickReplies(['查看滑雪服', '滑雪配件', '新手套装']);
  }
}
```

#### 错误处理优化
```javascript
// 友好的错误提示
case 'error':
  currentMessageElement.textContent =
    "抱歉，我遇到了一点问题。请稍后再试，或者换个方式问我？";
  break;

case 'rate_limit_exceeded':
  currentMessageElement.textContent =
    "当前咨询的人比较多，请稍等片刻再试~";
  break;
```

### 3.4 移动端优化

项目已包含移动端适配：

```javascript
// chat.js 中的移动端检测
this.isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

if (this.isMobile) {
  this.setupMobileViewport();  // 处理 iOS Safari 视口问题
}
```

```css
/* 移动端样式 */
@media (max-width: 480px) {
  .shop-ai-chat-window {
    width: 100%;
    height: 100%;
    border-radius: 0;
  }
}
```

---

## 四、部署和运维

### 4.1 部署方式对比

| 方式 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| 本地 + 隧道 | 简单、免费 | 不稳定、需要电脑开着 | 开发测试 |
| VPS 服务器 | 稳定、可控 | 需要运维 | 小规模生产 |
| Docker 容器 | 易于部署、可扩展 | 需要容器知识 | 中等规模 |
| 云平台 (Railway/Fly.io) | 简单、自动扩展 | 有成本 | 生产环境 |

### 4.2 环境变量配置

```bash
# .env 文件
CLAUDE_API_KEY=sk-ant-xxx          # Claude API 密钥
SHOPIFY_API_KEY=xxx                # Shopify App Client ID
SHOPIFY_API_SECRET=xxx             # Shopify App Client Secret
DATABASE_URL=file:./dev.db         # 数据库路径
```

### 4.3 Docker 部署

项目已包含 Dockerfile：

```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build
CMD ["npm", "run", "docker-start"]
```

部署命令：
```bash
docker build -t shop-chat-agent .
docker run -p 3000:3000 --env-file .env shop-chat-agent
```

### 4.4 监控和日志

#### 添加日志记录
```javascript
// 记录每次对话
console.log(JSON.stringify({
  timestamp: new Date().toISOString(),
  conversationId,
  userMessage,
  toolsUsed: [],
  responseTime: Date.now() - startTime
}));
```

#### 监控指标
- 响应时间
- 错误率
- 工具调用成功率
- 用户满意度（可添加反馈按钮）

### 4.5 成本控制

#### Claude API 成本估算

| 模型 | 输入价格 | 输出价格 | 单次对话估算 |
|------|---------|---------|-------------|
| Claude 3.5 Sonnet | $3/M tokens | $15/M tokens | ~$0.01-0.05 |
| Claude 3 Haiku | $0.25/M tokens | $1.25/M tokens | ~$0.001-0.005 |

#### 成本优化策略

1. **使用更便宜的模型处理简单问题**
```javascript
// 根据问题复杂度选择模型
const model = isSimpleQuery(userMessage)
  ? 'claude-3-haiku-20240307'
  : 'claude-3-5-sonnet-latest';
```

2. **限制对话历史长度**
```javascript
// 只保留最近 10 轮对话
const recentHistory = conversationHistory.slice(-20);
```

3. **缓存常见问题答案**
```javascript
const faqCache = {
  "退货政策": "我们提供 30 天无理由退货...",
  "配送时间": "一般 3-5 个工作日送达..."
};

if (faqCache[userMessage]) {
  return faqCache[userMessage];  // 不调用 API
}
```

### 4.6 安全注意事项

1. **API 密钥保护**
   - 不要提交到 Git
   - 使用环境变量
   - 定期轮换

2. **输入验证**
   - 限制消息长度
   - 过滤敏感词

3. **速率限制**
   - 限制每个用户的请求频率
   - 防止滥用

```javascript
// 简单的速率限制
const rateLimiter = new Map();

function checkRateLimit(userId) {
  const now = Date.now();
  const userRequests = rateLimiter.get(userId) || [];
  const recentRequests = userRequests.filter(t => now - t < 60000);

  if (recentRequests.length >= 10) {
    throw new Error('请求太频繁，请稍后再试');
  }

  rateLimiter.set(userId, [...recentRequests, now]);
}
```

---

## 五、常见问题解答

### Q1: 如何让 AI 只回答特定领域的问题？

在系统提示词中明确限制：
```
你只回答与本店产品和服务相关的问题。
对于其他话题（如政治、投资建议等），请礼貌地说：
"抱歉，这个问题超出了我的服务范围。我可以帮您查找产品或解答购物相关的问题。"
```

### Q2: 如何处理 AI 回答错误的情况？

1. 添加免责声明
2. 提供人工客服入口
3. 收集用户反馈，持续优化提示词

### Q3: 如何支持多语言？

1. 检测用户语言
2. 使用对应语言的提示词
3. 或在提示词中指定：`请使用用户使用的语言回复`

### Q4: 如何与现有客服系统集成？

1. 添加"转人工"功能
2. 将对话记录同步到 CRM
3. 设置触发条件（如用户表达不满时自动转人工）

---

## 六、扩展阅读

- [Claude Prompt Engineering Guide](https://docs.anthropic.com/claude/docs/prompt-engineering)
- [Shopify App Development](https://shopify.dev/docs/apps)
- [MCP Protocol Specification](https://modelcontextprotocol.io/docs)
