# Shopify AI 客服机器人 - 完整技术解析

> 基于 Shopify shop-chat-agent 开源项目的深度分析

---

## 一、整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户浏览器                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Shopify 店铺前端页面                               │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │         Chat Widget (Theme Extension)                        │   │   │
│  │  │         - chat.js (前端逻辑)                                  │   │   │
│  │  │         - chat.css (样式)                                    │   │   │
│  │  │         - chat-interface.liquid (HTML模板)                   │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP POST (SSE 流式传输)
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           后端服务 (React Router)                            │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  /chat 路由 (chat.jsx)                                                │  │
│  │  - 接收用户消息                                                        │  │
│  │  - 管理会话历史                                                        │  │
│  │  - 协调 Claude 和 MCP                                                 │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                    │                              │                         │
│                    ▼                              ▼                         │
│  ┌─────────────────────────┐      ┌─────────────────────────────────────┐  │
│  │  Claude Service          │      │  MCP Client                         │  │
│  │  - 调用 Claude API       │      │  - 连接 Shopify MCP 服务器           │  │
│  │  - 流式响应处理           │      │  - 执行工具调用                      │  │
│  └─────────────────────────┘      └─────────────────────────────────────┘  │
│                    │                              │                         │
└────────────────────┼──────────────────────────────┼─────────────────────────┘
                     │                              │
                     ▼                              ▼
          ┌──────────────────┐          ┌──────────────────────┐
          │  Claude API       │          │  Shopify MCP API      │
          │  (Anthropic)      │          │  - 产品搜索            │
          │                   │          │  - 购物车操作          │
          │                   │          │  - 订单查询            │
          │                   │          │  - 政策查询            │
          └──────────────────┘          └──────────────────────┘
```

### 核心组件说明

| 组件 | 位置 | 职责 |
|------|------|------|
| Chat Widget | `extensions/chat-bubble/` | 前端聊天界面，用户交互入口 |
| Chat Route | `app/routes/chat.jsx` | 后端 API，处理聊天请求 |
| Claude Service | `app/services/claude.server.js` | 封装 Claude API 调用 |
| MCP Client | `app/mcp-client.js` | 连接 Shopify MCP 服务器 |
| Tool Service | `app/services/tool.server.js` | 处理工具调用结果 |
| Streaming Service | `app/services/streaming.server.js` | SSE 流式传输 |

---

## 二、数据流详解

### 用户发送消息的完整流程

```
1. 用户输入 "帮我找一款滑雪板"
         │
         ▼
2. chat.js 捕获输入，发送 POST 请求到 /chat
   {
     message: "帮我找一款滑雪板",
     conversation_id: "123456",
     prompt_type: "standardAssistant"
   }
         │
         ▼
3. 后端 chat.jsx 接收请求
   - 保存用户消息到数据库
   - 获取历史对话记录
   - 连接 MCP 服务器获取可用工具
         │
         ▼
4. 调用 Claude API (带工具定义)
   Claude 分析用户意图，决定：
   - 直接回复文本？
   - 还是调用工具？
         │
         ▼
5. Claude 决定调用 search_shop_catalog 工具
   返回: { tool_use: "search_shop_catalog", input: { query: "滑雪板" } }
         │
         ▼
6. 后端通过 MCP Client 调用 Shopify MCP API
   POST https://shop.myshopify.com/api/mcp
   { method: "tools/call", params: { name: "search_shop_catalog", arguments: {...} } }
         │
         ▼
7. Shopify MCP 返回产品数据
   { products: [{ title: "专业滑雪板", price: "299.00", ... }] }
         │
         ▼
8. 工具结果返回给 Claude
   Claude 生成自然语言回复：
   "我找到了几款滑雪板，推荐这款专业滑雪板..."
         │
         ▼
9. 通过 SSE 流式传输回前端
   data: { type: "chunk", chunk: "我找到了" }
   data: { type: "chunk", chunk: "几款滑雪板" }
   data: { type: "product_results", products: [...] }
         │
         ▼
10. chat.js 实时渲染消息和产品卡片
```

### 时序图

```
用户        前端(chat.js)      后端(/chat)       Claude API      Shopify MCP
 │              │                  │                │                │
 │──输入消息───►│                  │                │                │
 │              │──POST /chat─────►│                │                │
 │              │                  │──stream()─────►│                │
 │              │                  │◄──tool_use────│                │
 │              │                  │──callTool()───────────────────►│
 │              │                  │◄──products────────────────────│
 │              │                  │──tool_result──►│                │
 │              │                  │◄──text stream──│                │
 │              │◄──SSE chunks─────│                │                │
 │◄──实时显示───│                  │                │                │
 │              │                  │                │                │
```

---

## 三、MCP (Model Context Protocol) 详解

### 什么是 MCP？

MCP 是一个标准化协议，让 AI 模型能够安全地调用外部工具和 API。

```
┌─────────────────────────────────────────────────────────────┐
│                    传统方式 vs MCP                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  传统方式:                                                   │
│  AI ──► 开发者写代码 ──► 调用各种 API ──► 返回结果            │
│  (需要为每个 API 写适配代码)                                  │
│                                                             │
│  MCP 方式:                                                   │
│  AI ──► MCP 协议 ──► 任何支持 MCP 的服务 ──► 返回结果         │
│  (标准化接口，即插即用)                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Shopify MCP 提供的工具

| 工具名称 | 功能 | 示例用户输入 |
|---------|------|-------------|
| `search_shop_catalog` | 搜索产品 | "找一款红色连衣裙" |
| `update_cart` | 添加/删除购物车商品 | "把这个加入购物车" |
| `get_cart` | 查看购物车 | "我的购物车里有什么" |
| `search_shop_policies_and_faqs` | 查询政策 | "你们的退货政策是什么" |
| `get_most_recent_order_status` | 查询最近订单 | "我的订单到哪了" |
| `get_order_status` | 查询特定订单 | "订单 #1234 的状态" |

### MCP Client 工作原理

文件位置: `app/mcp-client.js`

```javascript
// 1. 连接 MCP 服务器，获取可用工具列表
await mcpClient.connectToStorefrontServer();
// 返回: [{ name: "search_shop_catalog", description: "...", input_schema: {...} }, ...]

// 2. 调用工具
const result = await mcpClient.callTool("search_shop_catalog", { query: "滑雪板" });
// 返回: { products: [...] }
```

### JSON-RPC 2.0 协议

MCP 使用 JSON-RPC 2.0 协议通信：

```json
// 请求
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "id": 1,
  "params": {
    "name": "search_shop_catalog",
    "arguments": { "query": "滑雪板" }
  }
}

// 响应
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [{ "type": "text", "text": "{\"products\": [...]}" }]
  }
}
```

### 两种 MCP 端点

| 端点 | URL | 用途 | 是否需要认证 |
|------|-----|------|-------------|
| Storefront MCP | `https://shop.myshopify.com/api/mcp` | 产品搜索、购物车、政策查询 | 否 |
| Customer MCP | `https://shop.account.myshopify.com/customer/api/mcp` | 订单查询、退货 | 是 (OAuth) |

---

## 四、前端聊天小部件详解

### 组件结构

```
extensions/chat-bubble/
├── blocks/
│   └── chat-interface.liquid    # HTML 模板 + Shopify Schema
├── assets/
│   ├── chat.js                  # 前端交互逻辑 (~900行)
│   └── chat.css                 # 样式
├── locales/
│   └── en.default.json          # 多语言文本
└── shopify.extension.toml       # 扩展配置
```

### chat.js 核心模块

```javascript
const ShopAIChat = {
  UI: {
    // 界面交互：打开/关闭聊天窗口、滚动、显示加载动画
    toggleChatWindow(),
    showTypingIndicator(),
    removeTypingIndicator(),
    displayProductResults(products),
    scrollToBottom()
  },

  Message: {
    // 消息处理：发送消息、添加消息到界面
    send(chatInput, messagesContainer),
    add(text, sender, messagesContainer),
    addToolUse(toolMessage, messagesContainer)
  },

  API: {
    // API 通信：流式请求、处理 SSE 事件
    streamResponse(userMessage, conversationId, messagesContainer),
    handleStreamEvent(data, ...),
    fetchChatHistory(conversationId, messagesContainer)
  },

  Auth: {
    // 认证：处理需要登录的操作（如查看订单）
    openAuthPopup(authUrl),
    startTokenPolling(conversationId)
  },

  Product: {
    // 产品展示：创建产品卡片
    createCard(product)
  },

  Formatting: {
    // 文本格式化：Markdown 转 HTML
    formatMessageContent(element),
    convertMarkdownToHtml(text)
  }
};
```

### SSE (Server-Sent Events) 流式传输

```javascript
// 前端接收流式数据
const response = await fetch('/chat', { method: 'POST', ... });
const reader = response.body.getReader();

while (true) {
  const { value, done } = await reader.read();
  // value 包含: "data: {\"type\":\"chunk\",\"chunk\":\"你好\"}\n\n"

  // 解析并处理不同类型的事件
  switch (data.type) {
    case 'id':             // 会话 ID
    case 'chunk':          // 文本片段，实时显示
    case 'tool_use':       // 工具调用通知
    case 'message_complete': // 消息完成
    case 'product_results':  // 产品搜索结果
    case 'end_turn':       // 回复结束
    case 'error':          // 错误
    case 'rate_limit_exceeded': // 限流
  }
}
```

### Theme Extension 配置

文件: `blocks/chat-interface.liquid`

```liquid
{% schema %}
{
  "name": "AI Chat Assistant",
  "target": "body",
  "settings": [
    {
      "type": "color",
      "id": "chat_bubble_color",
      "label": "Chat Bubble Color",
      "default": "#5046e4"
    },
    {
      "type": "text",
      "id": "welcome_message",
      "label": "Welcome Message",
      "default": "Hi there! How can I help you today?"
    },
    {
      "type": "select",
      "id": "system_prompt",
      "label": "System Prompt",
      "options": [
        { "value": "standardAssistant", "label": "Standard Assistant" },
        { "value": "enthusiasticAssistant", "label": "Enthusiastic Assistant" }
      ]
    }
  ]
}
{% endschema %}
```

---

## 五、Claude AI 集成详解

### 系统提示词

文件: `app/prompts/prompts.json`

```json
{
  "systemPrompts": {
    "standardAssistant": {
      "content": "You are a helpful store assistant for an e-commerce shop. Answer the customer's questions in a friendly, helpful way about products, shipping, returns, or anything else about the store...",
      "version": "1.1"
    },
    "enthusiasticAssistant": {
      "content": "You are Zara, an enthusiastic and bubbly store assistant for an e-commerce shop. You're passionate about the products and love helping customers find exactly what they need...",
      "version": "1.0"
    }
  }
}
```

### Claude 调用流程

文件: `app/services/claude.server.js`

```javascript
// 1. 创建 Claude 客户端
const anthropic = new Anthropic({
  apiKey: process.env.CLAUDE_API_KEY,
  baseURL: 'https://proxy.shopify.ai/apis/anthropic'  // Shopify 代理
});

// 2. 流式对话
const stream = await anthropic.messages.stream({
  model: "claude-sonnet-4-20250514",  // 模型
  max_tokens: 1024,
  system: systemPrompt,               // 系统提示词
  messages: conversationHistory,      // 对话历史
  tools: mcpClient.tools              // 可用工具定义
});

// 3. 处理流式响应
stream.on('text', (chunk) => { /* 实时发送文本 */ });
stream.on('message', (message) => { /* 完整消息 */ });
stream.on('contentBlock', (block) => { /* 处理工具调用 */ });
```

### 工具调用循环

```
用户消息 ──► Claude 分析 ──► 需要工具？
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
           不需要                            需要
              │                               │
              ▼                               ▼
         直接回复文本                    返回 tool_use
                                             │
                                             ▼
                                      执行工具，获取结果
                                             │
                                             ▼
                                      结果返回给 Claude
                                             │
                                             ▼
                                      Claude 继续分析
                                      (可能再次调用工具)
                                             │
                                             ▼
                                      最终生成回复
```

代码实现 (chat.jsx:182-266):

```javascript
while (finalMessage.stop_reason !== "end_turn") {
  finalMessage = await claudeService.streamConversation({
    messages: conversationHistory,
    promptType,
    tools: mcpClient.tools
  }, {
    onText: (textDelta) => {
      stream.sendMessage({ type: 'chunk', chunk: textDelta });
    },
    onToolUse: async (content) => {
      // 调用工具
      const result = await mcpClient.callTool(content.name, content.input);
      // 结果加入对话历史，继续循环
      conversationHistory.push({
        role: 'user',
        content: [{ type: 'tool_result', tool_use_id: content.id, content: result }]
      });
    }
  });
}
```

---

## 六、会话管理与数据持久化

### 会话 ID 管理

```
前端 (sessionStorage)              后端 (SQLite/Prisma)
┌─────────────────────┐           ┌─────────────────────┐
│ shopAiConversationId │ ◄──────► │ Message 表           │
│ = "1733456789000"    │           │ - conversationId    │
└─────────────────────┘           │ - role (user/assistant)
                                  │ - content           │
                                  │ - createdAt         │
                                  └─────────────────────┘
```

### 对话历史格式

```javascript
// 发送给 Claude 的消息格式
[
  { role: "user", content: "帮我找滑雪板" },
  {
    role: "assistant",
    content: [{
      type: "tool_use",
      id: "toolu_xxx",
      name: "search_shop_catalog",
      input: { query: "滑雪板" }
    }]
  },
  {
    role: "user",
    content: [{
      type: "tool_result",
      tool_use_id: "toolu_xxx",
      content: "{\"products\": [...]}"
    }]
  },
  { role: "assistant", content: "我找到了这些滑雪板..." }
]
```

### 数据库模型

文件: `prisma/schema.prisma`

```prisma
model Message {
  id             String   @id @default(uuid())
  conversationId String
  role           String   // "user" | "assistant"
  content        String   // JSON 字符串
  createdAt      DateTime @default(now())
}

model CustomerToken {
  id             String   @id @default(uuid())
  conversationId String   @unique
  accessToken    String
  createdAt      DateTime @default(now())
}
```

---

## 七、认证流程

### OAuth 流程 (查看订单等需要登录的功能)

```
1. 用户: "查看我的订单"
         │
         ▼
2. Claude 调用 get_most_recent_order_status
         │
         ▼
3. Customer MCP 返回 401 未授权
         │
         ▼
4. 后端生成 OAuth 授权 URL
   (通过 Shopify Customer Account API)
         │
         ▼
5. 前端显示 "请点击这里登录"
         │
         ▼
6. 用户点击，弹出 Shopify 登录窗口
         │
         ▼
7. 用户登录成功，回调到 /auth/callback
         │
         ▼
8. 后端获取 Access Token，保存到数据库
         │
         ▼
9. 前端轮询 /auth/token-status 检测到 Token 可用
         │
         ▼
10. 自动重试原请求，返回订单信息
```

### 相关文件

- `app/auth.server.js` - 生成授权 URL
- `app/routes/auth.callback.jsx` - 处理 OAuth 回调
- `app/routes/auth.token-status.jsx` - Token 状态查询

---

## 八、项目文件结构

```
shop-chat-agent/
├── app/
│   ├── routes/
│   │   ├── chat.jsx              # 聊天 API 主入口
│   │   ├── app._index.jsx        # App 管理界面
│   │   ├── auth.callback.jsx     # OAuth 回调
│   │   └── auth.token-status.jsx # Token 状态
│   ├── services/
│   │   ├── claude.server.js      # Claude API 封装
│   │   ├── streaming.server.js   # SSE 流式传输
│   │   ├── tool.server.js        # 工具处理
│   │   └── config.server.js      # 配置
│   ├── prompts/
│   │   └── prompts.json          # 系统提示词
│   ├── mcp-client.js             # MCP 客户端
│   ├── db.server.js              # 数据库操作
│   ├── auth.server.js            # 认证逻辑
│   └── shopify.server.js         # Shopify App 配置
├── extensions/
│   └── chat-bubble/              # 前端聊天小部件
│       ├── blocks/
│       │   └── chat-interface.liquid
│       ├── assets/
│       │   ├── chat.js
│       │   └── chat.css
│       └── locales/
│           └── en.default.json
├── prisma/
│   └── schema.prisma             # 数据库模型
├── package.json
├── shopify.app.toml              # Shopify App 配置
└── .env.example                  # 环境变量示例
```

---

## 九、产品经理视角的关键洞察

### 1. 核心价值主张

- **自然语言购物体验**：用户不需要学习如何使用网站，直接说话就能完成购物
- **减少客服成本**：AI 处理常见问题，人工客服处理复杂问题
- **提高转化率**：即时响应，减少用户流失
- **7x24 服务**：AI 不需要休息，随时响应

### 2. 技术架构优势

- **MCP 标准化**：Shopify 提供标准 API，开发者无需了解底层实现
- **流式响应**：用户体验更好，不需要等待完整回复
- **会话持久化**：用户刷新页面后可以继续对话
- **Theme Extension**：无需修改主题代码，即插即用

### 3. 可扩展性

- **自定义提示词**：可以调整 AI 的性格和回复风格
- **自定义 UI**：可以修改聊天窗口的外观
- **添加新工具**：可以扩展 AI 的能力（如推荐系统、库存查询）
- **多语言支持**：通过 locales 文件支持多语言

### 4. 局限性

- **依赖 Claude API**：成本、延迟、可用性受限于 Anthropic
- **MCP 工具有限**：目前只支持 Shopify 提供的工具
- **需要 Shopify 店铺**：不能独立使用
- **认证复杂**：查看订单等功能需要用户登录

### 5. 成本考量

| 成本项 | 说明 |
|--------|------|
| Claude API | 按 Token 计费，每次对话约 $0.01-0.05 |
| 服务器 | 需要运行后端服务 |
| Shopify App | 免费（自定义 App） |

### 6. 竞品对比

| 特性 | 本项目 | Tidio | Zendesk | Intercom |
|------|--------|-------|---------|----------|
| AI 能力 | Claude (强) | 一般 | 一般 | 较强 |
| Shopify 集成 | 原生 MCP | 插件 | 插件 | 插件 |
| 自定义程度 | 完全开源 | 有限 | 有限 | 有限 |
| 成本 | API 费用 | 订阅制 | 订阅制 | 订阅制 |

---

## 十、下一步学习建议

1. **运行项目**：本地启动，体验完整流程
2. **修改提示词**：尝试自定义 AI 性格
3. **查看 MCP 文档**：了解更多可用工具
4. **阅读 Shopify 开发文档**：深入了解 Theme Extension
5. **研究 Claude API**：了解 Function Calling 机制

---

## 参考资料

- [Shopify MCP 开发文档](https://shopify.dev/docs/apps/build/storefront-mcp)
- [Model Context Protocol 官网](https://modelcontextprotocol.io/)
- [Claude API 文档](https://docs.anthropic.com/)
- [Shopify Theme Extension 文档](https://shopify.dev/docs/apps/build/online-store/theme-app-extensions)
